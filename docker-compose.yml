version: '2.1'
services:
    mysql_magento:
        image: 'mariadb:10.2'
        environment:
            - MYSQL_ROOT_PASSWORD=magento2
            - MYSQL_DATABASE=magento2
            - MYSQL_USER=magento2
            - MYSQL_PASSWORD=magento2
        ports:
            - '3306'
        volumes:
            - '.docker/mysql/:/var/lib/mysql'
        healthcheck:
            test: 'mysqladmin ping -h localhost'
            interval: 30s
            timeout: 30s
            retries: 3
        networks:
            magento:
                aliases:
                    - mysql_magento
    elasticsearch_magento:
        image: markoshust/magento-elasticsearch:7.6.2-2
        ports:
            - "9200:9200"
            - "9300:9300"
        environment:
            - "discovery.type=single-node"
        networks:
            magento:
                aliases:
                    - elasticsearch_magento
    #    nginx_magento:
    #        #        image: 'markoshust/magento-nginx:1.18-4'
    #        image: 'magento/magento-cloud-docker-nginx'
    #        ports:
    #            - "8000"
    #            - "4430"
    #        volumes: &appvolumes
    #            - ./:/var/www/html:cached
    #            - ./.docker/nginx/etc/nginx.conf:/etc/nginx/nginx.conf
    #            - ./.docker/nginx/etc/conf.d/:/etc/nginx/conf.d/
    #            - ./.docker/nginx/log/:/var/log/nginx/
    #            - sockdata:/sock
    #        networks:
    #            magento:
    #                aliases:
    #                    - nginx_magento
    #        depends_on:
    #            php_magento:
    #                condition: service_started
    #
    #    php_magento:
    #        image: 'markoshust/magento-php:7.4-fpm'
    #        volumes: *appvolumes
    #        networks:
    #            magento:
    #                aliases:
    #                    - php_magento
    #        depends_on:
    #            mysql_magento:
    #                condition: service_healthy

    fpm:
        hostname: fpm.magento2.docker
        image: 'magento/magento-cloud-docker-php:7.4-fpm-1.2.1'
        extends: generic
        volumes:
            - '.:/app:delegated'
        networks:
            magento:
                aliases:
                    - fpm_magento
        depends_on:
            mysql_magento:
                condition: service_started

    web:
        hostname: web.magento2.docker
        image: 'magento/magento-cloud-docker-nginx:1.19-1.2.1'
        extends: generic
        volumes:
            - '.:/app:delegated'
        environment:
            - WITH_XDEBUG=0
            - NGINX_WORKER_PROCESSES=1
            - NGINX_WORKER_CONNECTIONS=1024
        networks:
            magento:
                aliases:
                    - nginx_magento
        depends_on:
            fpm:
                condition: service_started
    varnish:
        hostname: varnish.magento2.docker
        image: 'magento/magento-cloud-docker-varnish:6.2-1.2.1'
        networks:
            magento:
                aliases:
                    - varnish_magento
        depends_on:
            web:
                condition: service_started
    tls:
        hostname: tls.magento2.docker
        image: 'magento/magento-cloud-docker-nginx:1.19-1.2.1'
        extends: generic
        volumes:
        -   './docker/log/:/var/log/nginx/:delegated'
        networks:
            magento:
                aliases:
                    - tls_magento
        environment:
            - NGINX_WORKER_PROCESSES=4
            - NGINX_WORKER_CONNECTIONS=1024
            - UPSTREAM_HOST=varnish
            - UPSTREAM_PORT=80
        ports:
            - '80:80'
            - '443:443'
        depends_on:
            varnish:
                condition: service_started

    generic:
        hostname: generic.magento2.docker
        image: 'magento/magento-cloud-docker-php:7.4-cli-1.2.1'
        env_file: ./.docker/config.env
        environment:
            - MAGENTO_RUN_MODE=developer
            - 'PHP_EXTENSIONS=bcmath bz2 calendar exif gd gettext intl mysqli pcntl pdo_mysql soap sockets sysvmsg sysvsem sysvshm opcache zip redis xsl sodium'

    redis_magento:
        image: redis:5.0-alpine
        networks:
            magento:
                aliases:
                    - redis_magento

networks:
    magento:
        driver: bridge

volumes:
    sockdata:
